<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Linjalla Map Demo</title>
    <!-- MapLibre GL JS CSS -->
    <link href="https://unpkg.com/maplibre-gl@4.7.1/dist/maplibre-gl.css" rel="stylesheet" />
    <!-- MapLibre GL JS Script -->
    <script src="https://unpkg.com/maplibre-gl@4.7.1/dist/maplibre-gl.js"></script>
    <!-- Turf.js for path calculations -->
    <script src="https://unpkg.com/@turf/turf@6/turf.min.js"></script>
    <style>
        body {
            margin: 0;
            padding: 0;
            background-color: #0b0f19;
            color: white;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
        }

        #map {
            position: absolute;
            top: 0;
            bottom: 0;
            width: 100%;
        }

        .overlay {
            position: absolute;
            top: 20px;
            left: 20px;
            background: rgba(11, 15, 25, 0.9);
            padding: 20px;
            border-radius: 16px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            max-width: 300px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
            z-index: 10;
        }

        h1 {
            margin: 0 0 10px 0;
            font-size: 1.2rem;
            font-weight: 700;
        }

        p {
            margin: 0;
            font-size: 0.9rem;
            color: #a0a0a0;
            line-height: 1.4;
        }
    </style>
</head>

<body>

    <div id="map"></div>
    <div class="overlay">
        <h1>Live Map Preview</h1>
        <p>Vehicles now follow real road geometries (simulated).</p>
    </div>

    <script>
        const map = new maplibregl.Map({
            container: 'map',
            style: 'https://basemaps.cartocdn.com/gl/dark-matter-gl-style/style.json',
            center: [24.945831, 60.192059], // Helsinki
            zoom: 13,
            pitch: 0,
            attributionControl: false
        });

        map.addControl(new maplibregl.AttributionControl({ compact: true }));

        // Define some major routes in Helsinki (approximate polylines)
        const ROUTES = {
            mannerheimintie: [[24.944081, 60.167689], [24.944071, 60.167689], [24.94362, 60.167677], [24.943284, 60.167669], [24.943181, 60.167668], [24.943036, 60.167662], [24.943019, 60.167661], [24.942881, 60.167654], [24.942523, 60.167617], [24.942376, 60.1676], [24.942304, 60.167591], [24.942184, 60.167576], [24.942041, 60.167672], [24.941957, 60.167726], [24.9416, 60.16796], [24.941494, 60.168055], [24.94115, 60.168283], [24.941084, 60.168325], [24.94099, 60.168385], [24.940906, 60.168438], [24.940854, 60.168472], [24.940832, 60.168486], [24.940792, 60.168511], [24.940722, 60.168555], [24.940705, 60.168566], [24.940209, 60.1689], [24.94011, 60.168982], [24.94, 60.169062], [24.939936, 60.169103], [24.939821, 60.169165], [24.939679, 60.169242], [24.939524, 60.169345], [24.938933, 60.169732], [24.938829, 60.1698], [24.938731, 60.169878], [24.938681, 60.169914], [24.938645, 60.169936], [24.938611, 60.169958], [24.938572, 60.169982], [24.938545, 60.170001], [24.938475, 60.170048], [24.938379, 60.170114], [24.938272, 60.170186], [24.938012, 60.170363], [24.937733, 60.170552], [24.937532, 60.170684], [24.937443, 60.170742], [24.937378, 60.170783], [24.937308, 60.170827], [24.937194, 60.170902], [24.937009, 60.171027], [24.936825, 60.17112], [24.936567, 60.171227], [24.93638, 60.171308], [24.936339, 60.171323], [24.936196, 60.171374], [24.936117, 60.171404], [24.936048, 60.171439], [24.935953, 60.171489], [24.935892, 60.171533], [24.935843, 60.171568], [24.935761, 60.171637], [24.935731, 60.171666], [24.935207, 60.172214], [24.935135, 60.172287], [24.935045, 60.172379], [24.934983, 60.172448], [24.934655, 60.172785], [24.934233, 60.173215], [24.934154, 60.173296], [24.9339, 60.173555], [24.933844, 60.173623], [24.933792, 60.173697], [24.93372, 60.173795], [24.933665, 60.173875], [24.933616, 60.173934], [24.933435, 60.174131], [24.93331, 60.174283], [24.933113, 60.174505], [24.932954, 60.174687], [24.932897, 60.174749], [24.932151, 60.175463], [24.932084, 60.175525], [24.932067, 60.17554], [24.931807, 60.175758], [24.93149, 60.176018], [24.931247, 60.176214], [24.93118, 60.17627], [24.93111, 60.176326], [24.931029, 60.176389], [24.930737, 60.176623], [24.930221, 60.177098], [24.930054, 60.177272], [24.929933, 60.177403], [24.929876, 60.177469], [24.92985, 60.177509], [24.929784, 60.17761], [24.929767, 60.17764], [24.929734, 60.17769], [24.929604, 60.1779], [24.929574, 60.17795], [24.929544, 60.177991], [24.92946, 60.178113], [24.929313, 60.178397], [24.929269, 60.178483], [24.929232, 60.178548], [24.929073, 60.178879], [24.929039, 60.178947], [24.928985, 60.179056], [24.928465, 60.180075], [24.928214, 60.180551], [24.928169, 60.180624], [24.927975, 60.180951], [24.927681, 60.181497], [24.927647, 60.181565], [24.92761, 60.181627], [24.927573, 60.181692], [24.927532, 60.181747], [24.927516, 60.181765], [24.927498, 60.181783], [24.927477, 60.181803], [24.927472, 60.181807], [24.927447, 60.18183], [24.927369, 60.181887], [24.927315, 60.18192], [24.927235, 60.181975], [24.926807, 60.18226], [24.926669, 60.182352], [24.926508, 60.18245], [24.926466, 60.182474], [24.926405, 60.182503], [24.926309, 60.182546], [24.926241, 60.182578], [24.926118, 60.182641], [24.925632, 60.182963], [24.925204, 60.183245], [24.925172, 60.183266], [24.924331, 60.183811], [24.924267, 60.183848], [24.924239, 60.183866], [24.92417, 60.183905], [24.924073, 60.183962], [24.923998, 60.184006], [24.923941, 60.18404], [24.923858, 60.184092], [24.923619, 60.184253], [24.923388, 60.184407], [24.923112, 60.184593], [24.922814, 60.184787], [24.922204, 60.185202], [24.922179, 60.18522], [24.922103, 60.185276], [24.922027, 60.185334], [24.921938, 60.185401], [24.9219, 60.18543], [24.921378, 60.185806], [24.920808, 60.18621], [24.919807, 60.186971], [24.919709, 60.187049], [24.919552, 60.187179], [24.919535, 60.187195], [24.919026, 60.187688], [24.918774, 60.187937], [24.918735, 60.187978], [24.918645, 60.188069], [24.918629, 60.188084], [24.918575, 60.188141], [24.918507, 60.188211], [24.9184, 60.188322], [24.917813, 60.188862], [24.91779, 60.188883], [24.917726, 60.188941], [24.917488, 60.189096], [24.91699, 60.189424], [24.91683, 60.189529], [24.916779, 60.189561], [24.916731, 60.189594], [24.916608, 60.189674], [24.916532, 60.189719], [24.916476, 60.189753], [24.916417, 60.189788], [24.916355, 60.189816], [24.915397, 60.190251], [24.915167, 60.190355], [24.91498, 60.190438], [24.914873, 60.190486], [24.914511, 60.190647], [24.914358, 60.190715], [24.913651, 60.19103], [24.913505, 60.191107], [24.913273, 60.191209], [24.913129, 60.191261], [24.912948, 60.191327], [24.912859, 60.191356], [24.912798, 60.191377], [24.912614, 60.191425], [24.912448, 60.191483], [24.911972, 60.191652], [24.911812, 60.19172], [24.911694, 60.191771], [24.911588, 60.191812], [24.910909, 60.19205], [24.910834, 60.192076], [24.910787, 60.192092], [24.910641, 60.192143], [24.910537, 60.192178], [24.910452, 60.192207], [24.910131, 60.192318], [24.909999, 60.192373], [24.909509, 60.192537], [24.908999, 60.192716], [24.908829, 60.192775], [24.908348, 60.192944], [24.908166, 60.193011], [24.907863, 60.193118], [24.90783, 60.193132], [24.907796, 60.193145], [24.907513, 60.193243], [24.907387, 60.193286], [24.90661, 60.193554], [24.906493, 60.193594], [24.906469, 60.193602], [24.906359, 60.193641], [24.906325, 60.193653], [24.905462, 60.193953], [24.905384, 60.19398], [24.904384, 60.194328], [24.904234, 60.194383], [24.904082, 60.194435], [24.903947, 60.194481], [24.903365, 60.194685], [24.903142, 60.194776], [24.903021, 60.194835], [24.902881, 60.194902], [24.902604, 60.195062], [24.902493, 60.195147], [24.902328, 60.195274], [24.902256, 60.195329], [24.902172, 60.195397], [24.902005, 60.195532], [24.901866, 60.195679], [24.901787, 60.195796], [24.901741, 60.19589], [24.901702, 60.196012], [24.901686, 60.196114], [24.90167, 60.196299], [24.90166, 60.196391], [24.901654, 60.196471], [24.901642, 60.196532], [24.90161, 60.196691], [24.90158, 60.196886], [24.901535, 60.197145], [24.901521, 60.197239], [24.901514, 60.197321], [24.901458, 60.197832], [24.901432, 60.198075], [24.901432, 60.198221], [24.901438, 60.198414], [24.901428, 60.198511], [24.90141, 60.1986], [24.901375, 60.198717], [24.901298, 60.198834], [24.90125, 60.198899], [24.900029, 60.20032], [24.899791, 60.200612], [24.899675, 60.200786], [24.899605, 60.200923], [24.899557, 60.201044], [24.899522, 60.20117], [24.899504, 60.201313], [24.899456, 60.202015], [24.899454, 60.20204], [24.899438, 60.202339], [24.899438, 60.202527], [24.899465, 60.202685], [24.899444, 60.202968], [24.899435, 60.203036], [24.899391, 60.203157], [24.899385, 60.203171], [24.899368, 60.20321], [24.899363, 60.203218], [24.899347, 60.203255], [24.899326, 60.203303], [24.899063, 60.203303], [24.898942, 60.203303], [24.898825, 60.203303], [24.898603, 60.203303], [24.898327, 60.203301], [24.898231, 60.2033], [24.898144, 60.2033], [24.897843, 60.203323], [24.897599, 60.20338], [24.897496, 60.203405], [24.895993, 60.203765], [24.895943, 60.20377], [24.895872, 60.203776], [24.895812, 60.2038], [24.895783, 60.203819], [24.895733, 60.203874], [24.895716, 60.203922], [24.895712, 60.203944], [24.895712, 60.20418], [24.895719, 60.204502], [24.895713, 60.204537], [24.895695, 60.204572], [24.895665, 60.204611], [24.895632, 60.20464], [24.895568, 60.204666], [24.895506, 60.204684], [24.895437, 60.204701], [24.895131, 60.204776], [24.893997, 60.205047], [24.893518, 60.205162], [24.893234, 60.205231], [24.892858, 60.205324], [24.892241, 60.20547], [24.892122, 60.205499], [24.892038, 60.205521], [24.891988, 60.205535], [24.891908, 60.205566], [24.89185, 60.205609], [24.891822, 60.205643], [24.891817, 60.205663], [24.891811, 60.205686], [24.891816, 60.205718], [24.891834, 60.205758], [24.891919, 60.205866], [24.891958, 60.205929], [24.891978, 60.205987], [24.891991, 60.206043], [24.892019, 60.206042], [24.892122, 60.20604], [24.892481, 60.206011], [24.892705, 60.20599], [24.892961, 60.206256]],
            hameenlinnanvayla: [[24.910006,60.190003],[24.909999,60.192373],[24.909509,60.192537],[24.908999,60.192716],[24.908348,60.192944],[24.907863,60.193118],[24.90661,60.193554],[24.905462,60.193953],[24.904384,60.194328],[24.903365,60.194685],[24.902604,60.195062],[24.901866,60.195679],[24.901702,60.196012],[24.90161,60.196691],[24.901535,60.197145],[24.901458,60.197832],[24.901438,60.198414],[24.901375,60.198717],[24.900029,60.20032],[24.899456,60.202015],[24.899438,60.202527],[24.899385,60.203171],[24.899326,60.203303],[24.895993,60.203765],[24.895712,60.20418],[24.895665,60.204611],[24.895131,60.204776],[24.892961,60.206256],[24.891816,60.205718],[24.887254,60.209322],[24.885666,60.210665],[24.884279,60.211904],[24.883391,60.21272],[24.883021,60.213076],[24.882791,60.213271],[24.882522,60.213429],[24.882337,60.213564],[24.882194,60.213677],[24.881773,60.214041],[24.88127,60.214476],[24.880996,60.214713],[24.880811,60.21487],[24.88062,60.215033],[24.880467,60.215163],[24.880436,60.21519]],
            sturenkatu: [[24.935207,60.172214],[24.935761,60.171637],[24.936339,60.171323],[24.937009,60.171027],[24.938012,60.170363],[24.938933,60.169732],[24.940722,60.168555],[24.9416,60.16796],[24.942523,60.167617],[24.944081,60.167689],[24.945391,60.174366],[24.946663,60.176082],[24.948175,60.17633],[24.949787,60.177983],[24.951752,60.178377],[24.954203,60.18536],[24.953535,60.185684],[24.953283,60.185973],[24.9525,60.1873],[24.952924,60.186634],[24.953406,60.1858],[24.954316,60.184988],[24.955365,60.179979],[24.95629,60.178401],[24.955034,60.177519],[24.953062,60.177735],[24.950711,60.178278],[24.949364,60.177669],[24.948575,60.176541],[24.946979,60.176166],[24.945805,60.175323],[24.944985,60.173873],[24.944062,60.172179],[24.94301,60.171165],[24.940989,60.171861],[24.938062,60.171926],[24.93976,60.171929],[24.940940,60.171705]],
            kallio_connector: [[24.9525, 60.1873], [24.952613, 60.187123], [24.952924, 60.186634], [24.953051, 60.18641], [24.95315, 60.186214], [24.953283, 60.185973], [24.953335, 60.185888], [24.953406, 60.1858], [24.953535, 60.185684], [24.953761, 60.185593], [24.954005, 60.185493], [24.954203, 60.18536], [24.954261, 60.185295], [24.954284, 60.185227], [24.954316, 60.184988], [24.954308, 60.18471], [24.954332, 60.184319], [24.954303, 60.184084], [24.954256, 60.183884], [24.954199, 60.183765], [24.95416, 60.183707], [24.953795, 60.183286], [24.953589, 60.183141], [24.953538, 60.18311], [24.953316, 60.182991], [24.953245, 60.182962], [24.953118, 60.182924], [24.952899, 60.182878], [24.952763, 60.182859], [24.952673, 60.18285], [24.9526, 60.182845], [24.952109, 60.182747], [24.952026, 60.182725], [24.95155, 60.18255], [24.951336, 60.18247], [24.951165, 60.182414], [24.951052, 60.182379], [24.95102, 60.182361], [24.950796, 60.182229], [24.950669, 60.182142], [24.950486, 60.181961], [24.950431, 60.181896], [24.950392, 60.181845], [24.950186, 60.181519], [24.950137, 60.181412], [24.950119, 60.181347], [24.950116, 60.181282], [24.950132, 60.181216], [24.95016, 60.181156], [24.950202, 60.181099], [24.950242, 60.18106], [24.950302, 60.181014], [24.950481, 60.180905], [24.950684, 60.18079], [24.950772, 60.180749], [24.950921, 60.180695], [24.951111, 60.18064], [24.951368, 60.180579], [24.951515, 60.180554], [24.95159, 60.180544], [24.951681, 60.180536], [24.951801, 60.180529], [24.951917, 60.180527], [24.952024, 60.180529], [24.952219, 60.18054], [24.952377, 60.180556], [24.95293, 60.18063], [24.95325, 60.180655], [24.953569, 60.180665], [24.953724, 60.180659], [24.95388, 60.180645], [24.954045, 60.18062], [24.954316, 60.180558], [24.954497, 60.180499], [24.954705, 60.180413], [24.954823, 60.180352], [24.95508, 60.180191], [24.955365, 60.179979], [24.955639, 60.179727], [24.95583, 60.179513], [24.955938, 60.17937], [24.956037, 60.179213], [24.956165, 60.178964], [24.956247, 60.178749], [24.956277, 60.178635], [24.956291, 60.178523], [24.95629, 60.178401], [24.956181, 60.178128], [24.956086, 60.177992], [24.956012, 60.177914], [24.955939, 60.177853], [24.955683, 60.177708], [24.955543, 60.177651], [24.955306, 60.177579], [24.955034, 60.177519], [24.954897, 60.177503], [24.954751, 60.177494], [24.954471, 60.177493], [24.954162, 60.17751], [24.953852, 60.177533], [24.953689, 60.177555], [24.953535, 60.177587], [24.953372, 60.177626], [24.953213, 60.177677], [24.953062, 60.177735], [24.952932, 60.1778], [24.952784, 60.17788], [24.952643, 60.177969], [24.952441, 60.178122], [24.952403, 60.178149], [24.9523, 60.178206], [24.952046, 60.178305], [24.951752, 60.178377], [24.951608, 60.178396], [24.951478, 60.178403], [24.951336, 60.178397], [24.951214, 60.178385], [24.950961, 60.178335], [24.950711, 60.178278], [24.950462, 60.178216], [24.950269, 60.178163], [24.950153, 60.178131], [24.950005, 60.17808], [24.949931, 60.178051], [24.949787, 60.177983], [24.949673, 60.177918], [24.949503, 60.177797], [24.949364, 60.177669], [24.949219, 60.177496], [24.949117, 60.177307], [24.949033, 60.177119], [24.948981, 60.177024], [24.948943, 60.176961], [24.948842, 60.176826], [24.94871, 60.176664], [24.948575, 60.176541], [24.948332, 60.176395], [24.948175, 60.17633], [24.947998, 60.176277], [24.947814, 60.17624], [24.947413, 60.176189], [24.94723, 60.176175], [24.946979, 60.176166], [24.946924, 60.176162], [24.946894, 60.176156], [24.946663, 60.176082], [24.946452, 60.175986], [24.946252, 60.175855], [24.946078, 60.1757], [24.945927, 60.175518], [24.945805, 60.175323], [24.945722, 60.175114], [24.9456, 60.174751], [24.945391, 60.174366], [24.945281, 60.174175], [24.94523, 60.174094], [24.945199, 60.174043], [24.945147, 60.173977], [24.945078, 60.173919], [24.944985, 60.173873], [24.94488, 60.173847], [24.944738, 60.173836], [24.944686, 60.173819], [24.944589, 60.173771], [24.944445, 60.173663], [24.944195, 60.173426], [24.944078, 60.173297], [24.944026, 60.173231], [24.943963, 60.173132], [24.943936, 60.173072], [24.943916, 60.173004], [24.943906, 60.172917], [24.943903, 60.172815], [24.943909, 60.17272], [24.943928, 60.172585], [24.943952, 60.172477], [24.943964, 60.172439], [24.944062, 60.172179], [24.944093, 60.172087], [24.944111, 60.172013], [24.944122, 60.171927], [24.944122, 60.171829], [24.944111, 60.171731], [24.944086, 60.171633], [24.944059, 60.171569], [24.944018, 60.171497], [24.943958, 60.171415], [24.943891, 60.171343], [24.943815, 60.171285], [24.943715, 60.171221], [24.943627, 60.171181], [24.943501, 60.171146], [24.943396, 60.171131], [24.94324, 60.171131], [24.943147, 60.171139], [24.94301, 60.171165], [24.942738, 60.171222], [24.942204, 60.171358], [24.941961, 60.171434], [24.941655, 60.171556], [24.941324, 60.171701], [24.940989, 60.171861], [24.940645, 60.172023], [24.940306, 60.172183], [24.940172, 60.172242], [24.939886, 60.172346], [24.939768, 60.172378], [24.939634, 60.172405], [24.93952, 60.172418], [24.93928, 60.172428], [24.939064, 60.172415], [24.9388, 60.172382], [24.938706, 60.172365], [24.938568, 60.172323], [24.938479, 60.172278], [24.938367, 60.172202], [24.938212, 60.17208], [24.938156, 60.172029], [24.938062, 60.171926], [24.938018, 60.171871], [24.937989, 60.171822], [24.937968, 60.171761], [24.937961, 60.171692], [24.937964, 60.171638], [24.937976, 60.171579], [24.938006, 60.17151], [24.938048, 60.171457], [24.938104, 60.171403], [24.938198, 60.171343], [24.93827, 60.171317], [24.938379, 60.171295], [24.938471, 60.171289], [24.938634, 60.171302], [24.93878, 60.171339], [24.938927, 60.171392], [24.939029, 60.171448], [24.939308, 60.17165], [24.939401, 60.17172], [24.93951, 60.171791], [24.93976, 60.171929], [24.939881, 60.17198], [24.940027, 60.17202], [24.940149, 60.172037], [24.940306, 60.172044], [24.940428, 60.172032], [24.940562, 60.172007], [24.940656, 60.171973], [24.940733, 60.171935], [24.940798, 60.171891], [24.940854, 60.171842], [24.940916, 60.171772], [24.940947, 60.171705], [24.94096, 60.171638], [24.94096, 60.171569], [24.940949, 60.171516], [24.940911, 60.171439], [24.940858, 60.171374], [24.940778, 60.171305], [24.940669, 60.171239], [24.940519, 60.171169], [24.940361, 60.171109], [24.940183, 60.171058], [24.939798, 60.170966], [24.939462, 60.17091], [24.939294, 60.170889], [24.939106, 60.170876], [24.93895, 60.170879], [24.938806, 60.170894], [24.938677, 60.170919], [24.938558, 60.17096], [24.938367, 60.171057], [24.938221, 60.171142], [24.938173, 60.171177], [24.93813, 60.171221], [24.938096, 60.171261], [24.938069, 60.171303], [24.938048, 60.171358], [24.938045, 60.171427], [24.938066, 60.171448], [24.938093, 60.171457], [24.938127, 60.17146], [24.938166, 60.171458], [24.9382, 60.171448], [24.938227, 60.171434], [24.93825, 60.171415], [24.938264, 60.171391], [24.938268, 60.171363], [24.938259, 60.171333], [24.938241, 60.171304], [24.938188, 60.171249], [24.938198, 60.171224], [24.938224, 60.171206], [24.938262, 60.171192], [24.938308, 60.171186], [24.938313, 60.171186], [24.938364, 60.171189], [24.93841, 60.1712], [24.938449, 60.171217], [24.938481, 60.17124], [24.9385, 60.171277], [24.938497, 60.17133], [24.938466, 60.171374], [24.938407, 60.17142], [24.938328, 60.171465], [24.93824, 60.171501], [24.938073, 60.171542], [24.937929, 60.171561], [24.937798, 60.171569], [24.937667, 60.171562], [24.937517, 60.171542], [24.937397, 60.171513], [24.937172, 60.17144], [24.936998, 60.171371], [24.936662, 60.171228], [24.936495, 60.171167], [24.936359, 60.171131], [24.936277, 60.171115], [24.936173, 60.171101], [24.936058, 60.171092], [24.935939, 60.171093], [24.935798, 60.171105], [24.935634, 60.171139], [24.935292, 60.171239], [24.934989, 60.171343], [24.934842, 60.171399], [24.934707, 60.171457], [24.934575, 60.171524], [24.934273, 60.171696], [24.933887, 60.171927], [24.933396, 60.172236], [24.933364, 60.172252], [24.93318, 60.172346], [24.933156, 60.172355], [24.933118, 60.17237], [24.93291, 60.172421], [24.932754, 60.172439], [24.932644, 60.172433], [24.93262, 60.172431], [24.932598, 60.172428], [24.932569, 60.172422], [24.932506, 60.172404], [24.932454, 60.172378], [24.932421, 60.172346], [24.932408, 60.172314], [24.932405, 60.17228], [24.932415, 60.172242], [24.932437, 60.172205], [24.932568, 60.17208], [24.932824, 60.171881], [24.93309, 60.171694], [24.933177, 60.171639], [24.933256, 60.171597], [24.933353, 60.171556], [24.933458, 60.171524], [24.933575, 60.171498], [24.933719, 60.171477], [24.933869, 60.17147], [24.934027, 60.171479], [24.934167, 60.171501], [24.9343, 60.171534], [24.934421, 60.171579], [24.934524, 60.171638], [24.934559, 60.171663], [24.934594, 60.171688], [24.934626, 60.171719], [24.934651, 60.171755], [24.934668, 60.171796], [24.934676, 60.171842], [24.934672, 60.171891], [24.934658, 60.171939], [24.934633, 60.171987], [24.934608, 60.172019], [24.934547, 60.172079], [24.934479, 60.17215], [24.934418, 60.172217], [24.934327, 60.172305], [24.933221, 60.173004], [24.932646, 60.173369], [24.932233, 60.173627], [24.931792, 60.17388], [24.931707, 60.173926], [24.931604, 60.173966], [24.931441, 60.174005], [24.931281, 60.174021], [24.93112, 60.174017], [24.930965, 60.173995], [24.930819, 60.173956], [24.930689, 60.173908], [24.930263, 60.173708], [24.930064, 60.173629], [24.929873, 60.17357], [24.929759, 60.173549], [24.929705, 60.173543], [24.929553, 60.173539], [24.929344, 60.173562], [24.929119, 60.173614], [24.928892, 60.173691], [24.928671, 60.173787], [24.928468, 60.173902], [24.928285, 60.174026], [24.927231, 60.174828], [24.927052, 60.174984], [24.92694, 60.175114], [24.926868, 60.175249], [24.926834, 60.17539], [24.926835, 60.175586], [24.926867, 60.175791], [24.926947, 60.175953], [24.927063, 60.176106], [24.927164, 60.176214], [24.927354, 60.176378], [24.927572, 60.176527], [24.927828, 60.176662], [24.928114, 60.176778], [24.928135, 60.176786], [24.92815, 60.176791], [24.92842, 60.176884], [24.928682, 60.176949], [24.928929, 60.176985], [24.929285, 60.177002], [24.929532, 60.176981], [24.929729, 60.17693], [24.929881, 60.176856], [24.929994, 60.176766], [24.930064, 60.176667], [24.930089, 60.176561], [24.930074, 60.176461], [24.930018, 60.176363], [24.929924, 60.176269], [24.929531, 60.176008], [24.929388, 60.175902], [24.929007, 60.175586], [24.928373, 60.175225], [24.928329, 60.1752], [24.928095, 60.175107], [24.927903, 60.17507], [24.927599, 60.175058], [24.927282, 60.175083], [24.92697, 60.175141], [24.926683, 60.175228], [24.925004, 60.175877], [24.924729, 60.176001], [24.924483, 60.176149], [24.924278, 60.176317], [24.924119, 60.176497], [24.924016, 60.17669], [24.923963, 60.17688], [24.923964, 60.177028], [24.923996, 60.177174], [24.92406, 60.177312], [24.924155, 60.177439], [24.92476, 60.17808], [24.925206, 60.178556], [24.922442, 60.175553], [24.922437, 60.175548], [24.922378, 60.175484], [24.922105, 60.175833]]
        };

        // Flatten logic: Create multiple vehicle instances per route
        const vehicles = [];
        let idCounter = 0;

        Object.keys(ROUTES).forEach(routeName => {
            const coords = ROUTES[routeName];
            const line = turf.lineString(coords);
            const length = turf.length(line);

            // Add a few vehicles per route, spaced out
            const count = 3 + Math.floor(Math.random() * 3);

            for (let i = 0; i < count; i++) {
                vehicles.push({
                    id: idCounter++,
                    type: Math.random() > 0.4 ? 'bus' : 'tram',
                    line: line,
                    routeLen: length,
                    progress: Math.random() * length, // Start at random position
                    speed: 0.0003 + (Math.random() * 0.0002), // random speed km/frame approx
                    direction: Math.random() > 0.5 ? 1 : -1
                });
            }
        });

        map.on('load', () => {

            map.addSource('vehicles', {
                type: 'geojson',
                data: getGeoJson(vehicles)
            });

            // Halo
            map.addLayer({
                id: 'vehicle-glow',
                type: 'circle',
                source: 'vehicles',
                paint: {
                    'circle-radius': 12,
                    'circle-color': [
                        'match', ['get', 'type'],
                        'bus', '#007AFF',
                        'tram', '#00985F',
                        '#888'
                    ],
                    'circle-opacity': 0.3,
                    'circle-blur': 0.5
                }
            });

            // Core
            map.addLayer({
                id: 'vehicle-core',
                type: 'circle',
                source: 'vehicles',
                paint: {
                    'circle-radius': 5,
                    'circle-color': [
                        'match', ['get', 'type'],
                        'bus', '#007AFF',
                        'tram', '#00985F',
                        '#fff'
                    ],
                    'circle-stroke-width': 2,
                    'circle-stroke-color': '#ffffff'
                }
            });

            animate();
        });

        function getGeoJson(data) {
            return {
                type: 'FeatureCollection',
                features: data.map(v => {
                    // Calculate current position along line
                    const point = turf.along(v.line, v.progress);
                    return {
                        type: 'Feature',
                        geometry: point.geometry,
                        properties: {
                            type: v.type,
                            id: v.id
                        }
                    };
                })
            };
        }

        function animate() {
            vehicles.forEach(v => {
                v.progress += v.speed * v.direction;

                // Bounce at ends of route
                if (v.progress >= v.routeLen) {
                    v.progress = v.routeLen;
                    v.direction = -1;
                } else if (v.progress <= 0) {
                    v.progress = 0;
                    v.direction = 1;
                }
            });

            const source = map.getSource('vehicles');
            if (source) {
                source.setData(getGeoJson(vehicles));
            }

            requestAnimationFrame(animate);
        }
    </script>

</body>

</html>